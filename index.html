<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نموذج طلب رصيد رقمي</title>
  <!-- تحميل مكتبات React و ReactDOM من CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- تحميل Babel لتحويل كود JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- تحميل Tailwind CSS من CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* تحديد خط Inter كخط أساسي لجميع العناصر */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body>
  <!-- هذا العنصر هو الذي سيتم فيه عرض تطبيق React -->
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // هذا هو المكون الرئيسي للتطبيق، وهو يتولى جميع عمليات الواجهة وإدارة البيانات.
    const App = () => {
      // `formData`: حالة (state) لتخزين جميع البيانات المدخلة في النموذج.
      const [formData, setFormData] = useState({
        balance_type: '',
        crypto_name: '',
        crypto_network: '',
        wallet_name: '',
        wallet_currency: '',
        amount_requested: 0,
        service_fee_value: 0,
        receiver_address: '',
        notes: '',
        payment_method: '',
        payment_currency: 'ريال سعودي',
        final_amount_due_usd: 0,
        final_amount_due_converted: 0,
      });

      // حالات (states) إضافية لإدارة واجهة المستخدم.
      const [formSubmitted, setFormSubmitted] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [orderId, setOrderId] = useState('');
      const [cryptoPrices, setCryptoPrices] = useState({
        BTC: 60000,
        ETH: 3000,
        SOL: 150
      });
      const [isPriceLoading, setIsPriceLoading] = useState(false);

      // أسعار الصرف الثابتة لغرض العرض.
      const exchangeRates = {
        'ريال سعودي': 3.83,
        'ريال يمني شمال': 538,
        'ريال يمني جنوب': 2000,
      };
      
      // ربط أسماء العملات برموزها في واجهة برمجة التطبيقات (API).
      const cryptoSymbolMap = {
        'Bitcoin': 'BTC',
        'Ethereum': 'ETH',
        'Solana': 'SOL',
        'USDT': 'USDT'
      };

      // `useEffect`: خطاف (hook) يُستخدم لجلب أسعار العملات الرقمية عند تحميل التطبيق.
      // كما يقوم بتحديث الأسعار كل 60 ثانية.
      useEffect(() => {
        // وظيفة لجلب الأسعار من CryptoCompare.
        const fetchAllCryptoPrices = async () => {
          setIsPriceLoading(true);
          const baseUrl = 'https://min-api.cryptocompare.com/data/pricemulti';
          const params = { "fsyms": "BTC,ETH,SOL", "tsyms": "USDT" };
          const url = new URL(baseUrl);
          url.search = new URLSearchParams(params).toString();
          
          try {
            const response = await fetch(url);
            const data = await response.json();
            if (data) {
              setCryptoPrices({
                BTC: data.BTC ? data.BTC.USDT : cryptoPrices.BTC,
                ETH: data.ETH ? data.ETH.USDT : cryptoPrices.ETH,
                SOL: data.SOL ? data.SOL.USDT : cryptoPrices.SOL
              });
            }
          } catch (error) {
            console.error('فشل جلب أسعار العملات الرقمية من CryptoCompare:', error);
          } finally {
            setIsPriceLoading(false);
          }
        };

        fetchAllCryptoPrices();
        const interval = setInterval(fetchAllCryptoPrices, 60000);
        return () => clearInterval(interval);
      }, []);

      // وظيفة لحساب رسوم الخدمة بناءً على الكمية ونوع العملة.
      const calculateServiceFee = (amount, cryptoName, cryptoPrice) => {
        const specialFeeCryptos = ['Bitcoin', 'Solana', 'Ethereum'];

        if (specialFeeCryptos.includes(cryptoName)) {
          const dollarValue = amount * cryptoPrice;
          return dollarValue * 0.06;
        }

        if (amount < 10) {
          return 2;
        } else if (amount <= 50) {
          return 2.5;
        } else if (amount <= 1000) {
          return amount * 0.05;
        } else {
          return amount * 0.045;
        }
      };

      // `useEffect`: خطاف يُعيد حساب المبالغ النهائية تلقائياً عند تغيير أي حقل ذي صلة.
      useEffect(() => {
        const updatedAmount = parseFloat(formData.amount_requested);
        const updatedPaymentCurrency = formData.payment_currency;
        
        let currentCryptoPrice = 1;
        const cryptoSymbol = cryptoSymbolMap[formData.crypto_name];
        if (cryptoSymbol === 'USDT') {
          currentCryptoPrice = 1;
        } else if (cryptoSymbol && cryptoPrices[cryptoSymbol]) {
          currentCryptoPrice = cryptoPrices[cryptoSymbol];
        }

        const fee = calculateServiceFee(updatedAmount, formData.crypto_name, currentCryptoPrice);

        const amounts = calculateFinalAmount(updatedAmount, fee, currentCryptoPrice, updatedPaymentCurrency);

        setFormData(prev => ({
          ...prev,
          service_fee_value: fee,
          final_amount_due_usd: amounts.totalUSD,
          final_amount_due_converted: amounts.convertedAmount,
        }));
      }, [formData.amount_requested, formData.payment_currency, formData.crypto_name, cryptoPrices]);

      // وظيفة حساب المبلغ النهائي.
      const calculateFinalAmount = (amount, fee, currentCryptoPrice, paymentCurrency) => {
        const totalUSD = (amount * currentCryptoPrice) + fee;
        const convertedAmount = paymentCurrency === 'دولار أمريكي' ? totalUSD : totalUSD * (exchangeRates[paymentCurrency] || 1);
        return {
          totalUSD: totalUSD,
          convertedAmount: convertedAmount,
        };
      };

      // `handleInputChange`: وظيفة لتحديث حالة النموذج عند إدخال البيانات في الحقول.
      const handleInputChange = (e) => {
        const { name, value } = e.target;
        let newFormData = { ...formData, [name]: value };

        if (name === 'balance_type') {
          newFormData = {
            ...newFormData,
            crypto_name: '',
            crypto_network: '',
            wallet_name: '',
            wallet_currency: '',
          };
        }

        setFormData(newFormData);
      };

      // `handleSubmit`: وظيفة لمعالجة إرسال النموذج.
      // تم تعديل هذه الوظيفة لإرسال البيانات إلى واجهة API بدلاً من Firebase.
      const handleSubmit = async (e) => {
        e.preventDefault();
        setIsSubmitting(true);
        
        try {
          // قم باستبدال 'https://your-backend-api.com/submit' بنقطة نهاية الخادم الخاص بك.
          // يجب أن يكون خادمك مبرمجاً لاستقبال هذه البيانات ومعالجتها.
          // يمكن استخدام Node.js مع Express، أو Python مع Flask، أو أي لغة أخرى.
          const response = await fetch('https://topup-back.onrender.com/submit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
          });

          if (!response.ok) {
            throw new Error(`خطأ في الشبكة: ${response.statusText}`);
          }
          
          const result = await response.json();
          // هنا يمكنك استخدام رقم الطلب الذي يعيده الخادم.
          setOrderId(result.orderId || 'غير متوفر');
          setFormSubmitted(true);
          console.log('تم إرسال الطلب بنجاح:', result);

        } catch (e) {
          console.error("فشل إرسال الطلب:", e);
          // يمكنك عرض رسالة خطأ للمستخدم هنا
        } finally {
          setIsSubmitting(false);
        }
      };

      // وظيفة لمشاركة تفاصيل الطلب على واتساب.
      const handleShare = () => {
        const shareText = `*تم إرسال طلب جديد!*
-----------------------------
*رقم الطلب:* ${orderId}
*نوع الرصيد:* ${formData.balance_type === 'crypto' ? formData.crypto_name : formData.wallet_name}
*الكمية:* ${formData.amount_requested}
*الرسوم:* ${formData.service_fee_value.toFixed(2)} USD
*المبلغ النهائي:* ${formData.final_amount_due_converted.toFixed(2)} ${formData.payment_currency}`;
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
        window.open(whatsappUrl, '_blank');
      };

      // دوال مساعدة لتقديم أقسام النموذج بناءً على نوع الرصيد.
      const renderCryptoSection = () => (
        <div className="space-y-4">
          <div className="p-4 bg-gray-50 rounded-lg">
            <label className="block text-sm font-medium text-gray-700 mb-1">ما اسم العملة الرقمية؟</label>
            <select
              name="crypto_name"
              value={formData.crypto_name}
              onChange={handleInputChange}
              className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
            >
              <option value="">اختر...</option>
              <option value="USDT">USDT</option>
              <option value="Bitcoin">Bitcoin</option>
              <option value="Solana">Solana</option>
              <option value="Ethereum">Ethereum</option>
              <option value="أخرى">أخرى</option>
            </select>
          </div>
          <div className="p-4 bg-gray-50 rounded-lg">
            <label className="block text-sm font-medium text-gray-700 mb-1">ما هي الشبكة المطلوبة؟</label>
            <select
              name="crypto_network"
              value={formData.crypto_network}
              onChange={handleInputChange}
              className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
            >
              <option value="">اختر...</option>
              <option value="BEP20">BEP20</option>
              <option value="TRC20">TRC20</option>
              <option value="ERC20">ERC20</option>
              <option value="Solana">Solana</option>
              <option value="أخرى">أخرى</option>
            </select>
          </div>
          {(formData.crypto_name === 'Bitcoin' || formData.crypto_name === 'Solana' || formData.crypto_name === 'Ethereum') && (
            <div className="p-4 bg-yellow-50 rounded-lg text-sm text-yellow-800">
              {isPriceLoading ? (
                <p>جاري جلب السعر...</p>
              ) : (
                <p>السعر الحالي لـ {formData.crypto_name}: ~{cryptoPrices[cryptoSymbolMap[formData.crypto_name]]?.toFixed(2)} دولار أمريكي</p>
              )}
            </div>
          )}
        </div>
      );

      const renderWalletSection = () => (
        <div className="space-y-4">
          <div className="p-4 bg-gray-50 rounded-lg">
            <label className="block text-sm font-medium text-gray-700 mb-1">ما اسم المحفظة؟</label>
            <select
              name="wallet_name"
              value={formData.wallet_name}
              onChange={handleInputChange}
              className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
            >
              <option value="">اختر...</option>
              <option value="PayPal">PayPal</option>
              <option value="Neteller">Neteller</option>
              <option value="Skrill">Skrill</option>
              <option value="Perfect Money">Perfect Money</option>
              <option value="أخرى">أخرى</option>
            </select>
          </div>
          <div className="p-4 bg-gray-50 rounded-lg">
            <label className="block text-sm font-medium text-gray-700 mb-1">العملة داخل المحفظة؟</label>
            <select
              name="wallet_currency"
              value={formData.wallet_currency}
              onChange={handleInputChange}
              className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
            >
              <option value="">اختر...</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
              <option value="أخرى">أخرى</option>
            </select>
          </div>
        </div>
      );

      // إذا تم إرسال النموذج بنجاح، يتم عرض رسالة التأكيد.
      if (formSubmitted) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            <div className="max-w-md w-full bg-white p-8 rounded-xl shadow-lg border border-gray-200 text-right font-sans">
              <h2 className="text-2xl font-bold text-gray-900 text-center mb-6">تم استلام طلبك بنجاح!</h2>
              <div className="space-y-4 text-gray-700">
                <p><strong>رقم الطلب:</strong> {orderId}</p>
                <p><strong>نوع الرصيد:</strong> {formData.balance_type}</p>
                {formData.balance_type === 'crypto' && (
                  <>
                    <p><strong>العملة الرقمية:</strong> {formData.crypto_name}</p>
                    <p><strong>الشبكة:</strong> {formData.crypto_network}</p>
                  </>
                )}
                {formData.balance_type === 'wallet' && (
                  <>
                    <p><strong>اسم المحفظة:</strong> {formData.wallet_name}</p>
                    <p><strong>عملة المحفظة:</strong> {formData.wallet_currency}</p>
                  </>
                )}
                <p><strong>الكمية المطلوبة:</strong> {formData.amount_requested}</p>
                <p><strong>رسوم الخدمة:</strong> {formData.service_fee_value.toFixed(2)} USD</p>
                <p><strong>عنوان الاستلام:</strong> {formData.receiver_address}</p>
                <p><strong>الملاحظات:</strong> {formData.notes || 'لا توجد'}</p>
                <p><strong>طريقة الدفع:</strong> {formData.payment_method}</p>
                <p><strong>عملة الدفع:</strong> {formData.payment_currency}</p>
                <p><strong>المبلغ النهائي المطلوب دفعه (بالدولار):</strong> {formData.final_amount_due_usd.toFixed(2)} USD</p>
                <p><strong>المبلغ النهائي المطلوب دفعه (بالعملة المحلية):</strong> {formData.final_amount_due_converted.toFixed(2)} {formData.payment_currency}</p>
              </div>
              <button
                onClick={handleShare}
                className="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out"
              >
                مشاركة على واتساب
              </button>
              <p className="mt-6 text-sm text-center text-gray-500">
                سيتم التواصل معك قريباً لإتمام عملية الدفع.
              </p>
            </div>
          </div>
        );
      }

      // هذا هو محتوى النموذج الرئيسي
      return (
        <div dir="rtl" className="min-h-screen bg-gray-100 flex items-center justify-center p-4 sm:p-6 lg:p-8">
          <form onSubmit={handleSubmit} className="max-w-md w-full bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 space-y-6 font-sans">
            <h1 className="text-3xl font-bold text-gray-900 text-center">طلب شحن رصيد رقمي</h1>
            <p className="text-center text-gray-500">يرجى ملء الحقول التالية لإكمال طلبك.</p>
            
            {isSubmitting && (
              <div className="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10">
                <div className="text-center p-4 rounded-md shadow-lg bg-white">
                  <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
                  <p className="text-lg font-medium text-gray-700">جاري إرسال طلبك...</p>
                </div>
              </div>
            )}

            {/* تفاصيل الرصيد */}
            <div>
              <h2 className="text-xl font-semibold text-gray-800 mb-4">تفاصيل الرصيد المطلوب</h2>
              <div className="p-4 bg-gray-50 rounded-lg">
                <label htmlFor="balance_type" className="block text-sm font-medium text-gray-700 mb-1">نوع الرصيد المراد شحنه</label>
                <select
                  id="balance_type"
                  name="balance_type"
                  value={formData.balance_type}
                  onChange={handleInputChange}
                  required
                  className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                >
                  <option value="">اختر...</option>
                  <option value="crypto">💱 عملة رقمية</option>
                  <option value="wallet">👜 محفظة إلكترونية</option>
                </select>
              </div>
              {formData.balance_type === 'crypto' && renderCryptoSection()}
              {formData.balance_type === 'wallet' && renderWalletSection()}
            </div>

            {/* تفاصيل الطلب */}
            <div>
              <h2 className="text-xl font-semibold text-gray-800 mb-4">تفاصيل الطلب</h2>
              <div className="space-y-4">
                <div className="p-4 bg-gray-50 rounded-lg">
                  <label htmlFor="amount_requested" className="block text-sm font-medium text-gray-700 mb-1">💰 الكمية المطلوبة</label>
                  <p className="text-xs text-gray-500 mb-2">أدخل الكمية التي ترغب باستلامها (مثلاً: 100)</p>
                  <input
                    type="number"
                    id="amount_requested"
                    name="amount_requested"
                    value={formData.amount_requested}
                    onChange={handleInputChange}
                    required
                    className="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                  />
                </div>
                <div className="p-4 bg-gray-50 rounded-lg">
                  <label htmlFor="service_fee_value" className="block text-sm font-medium text-gray-700 mb-1">💸 رسوم الخدمة</label>
                  <p className="text-xs text-gray-500 mb-2">يتم احتسابها تلقائيًا بناءً على الكمية.</p>
                  <input
                    type="text"
                    id="service_fee_value"
                    name="service_fee_value"
                    value={formData.service_fee_value.toFixed(2)}
                    readOnly
                    className="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-200 cursor-not-allowed sm:text-sm"
                  />
                </div>
                <div className="p-4 bg-gray-50 rounded-lg">
                  <label htmlFor="receiver_address" className="block text-sm font-medium text-gray-700 mb-1">📥 عنوان الاستلام</label>
                  <p className="text-xs text-gray-500 mb-2">أدخل عنوان المحفظة أو عنوان العملة الرقمية بدقة</p>
                  <textarea
                    id="receiver_address"
                    name="receiver_address"
                    rows="3"
                    value={formData.receiver_address}
                    onChange={handleInputChange}
                    required
                    className="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                  ></textarea>
                </div>
                <div className="p-4 bg-gray-50 rounded-lg">
                  <label htmlFor="notes" className="block text-sm font-medium text-gray-700 mb-1">📝 ملاحظات إضافية (اختياري)</label>
                  <textarea
                    id="notes"
                    name="notes"
                    rows="2"
                    value={formData.notes}
                    onChange={handleInputChange}
                    className="mt-1 block w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                  ></textarea>
                </div>
              </div>
            </div>

            {/* تفاصيل الدفع */}
            <div>
              <h2 className="text-xl font-semibold text-gray-800 mb-4">تفاصيل الدفع</h2>
              <div className="space-y-4">
                <div className="p-4 bg-gray-50 rounded-lg">
                  <label htmlFor="payment_method" className="block text-sm font-medium text-gray-700 mb-1">🏦 طريقة الدفع المفضلة</label>
                  <select
                    id="payment_method"
                    name="payment_method"
                    value={formData.payment_method}
                    onChange={handleInputChange}
                    required
                    className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                  >
                    <option value="">اختر...</option>
                    <option value="بنك الراجحي">بنك الراجحي</option>
                    <option value="STC Pay">STC Pay</option>
                    <option value="بنك الأهلي">بنك الأهلي</option>
                    <option value="حوالة محلية">حوالة محلية</option>
                    <option value="أخرى">أخرى</option>
                  </select>
                </div>
                <div className="p-4 bg-gray-50 rounded-lg">
                  <label htmlFor="payment_currency" className="block text-sm font-medium text-gray-700 mb-1">💱 العملة التي ستدفع بها</label>
                  <select
                    id="payment_currency"
                    name="payment_currency"
                    value={formData.payment_currency}
                    onChange={handleInputChange}
                    required
                    className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                  >
                    <option value="">اختر...</option>
                    <option value="ريال سعودي">ريال سعودي</option>
                    <option value="ريال يمني شمال">ريال يمني شمال</option>
                    <option value="ريال يمني جنوب">ريال يمني جنوب</option>
                    <option value="دولار أمريكي">دولار أمريكي</option>
                  </select>
                </div>
                <div className="p-4 bg-blue-100 rounded-lg">
                  <label htmlFor="final_amount_due" className="block text-sm font-bold text-blue-800 mb-1">🔢 المبلغ النهائي المطلوب دفعه</label>
                  <p className="text-xs text-blue-700 mb-2">
                    سعر الصرف هو: {formData.payment_currency === 'دولار أمريكي' ? '1.00' : (exchangeRates[formData.payment_currency] || '...')} (مقابل 1 دولار).
                  </p>
                  <div className="mt-1 flex items-center">
                    <span className="text-2xl font-extrabold text-blue-900 mr-2">
                      {formData.final_amount_due_usd.toFixed(2)}
                    </span>
                    <span className="text-lg text-blue-800">
                      دولار أمريكي
                    </span>
                  </div>
                  {formData.payment_currency !== 'دولار أمريكي' && (
                    <div className="mt-1 flex items-center">
                      <span className="text-2xl font-extrabold text-blue-900 mr-2">
                        {formData.final_amount_due_converted.toFixed(2)}
                      </span>
                      <span className="text-lg text-blue-800">
                        {formData.payment_currency}
                      </span>
                    </div>
                  )}
                </div>
              </div>
            </div>

            <button
              type="submit"
              disabled={isSubmitting}
              className="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
            >
              {isSubmitting ? 'جاري الإرسال...' : 'إرسال الطلب'}
            </button>
          </form>
        </div>
      );
    };

    // هذا السطر يقوم ببدء تشغيل تطبيق React وربطه بعنصر HTML ذي المعرف "root".
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
